
library(broom)
library(tidyr)
#set the woring directory
setwd ('C:/Users/lhs36/OneDrive - Drexel University/Redlining/urban_heat_redlining/data')


library(broom)
library(tidyr)
library(lme4)
library(geepack)
library(tableone)
#set the woring directory
setwd ('C:/Users/lhs36/OneDrive - Drexel University/Redlining/urban_heat_redlining/data')

#view the files in the working directory
list.files()

#read in the data

#p_holc_v<-read.csv("holc_parcels_census.csv")
p_holc_v<-read.csv("p_holc_v_census1940new3.csv")
##################################################################################


m<-p_holc_v
#RECODE
var<-m$ICE_blk_inc_1317
summary<-summary(var)


##a value of 1 connotes that all residents are in the
##privileged group and a value of -1 denotes that all residents are in the most deprived group

#coding such that 3 = most disadvantages, 0=most advantaged

m$ice_1317_blkcat<-ifelse(is.na(var), NA,
                          ifelse(var>= summary[1] & var<= summary[2], "1. LOW: MOST DEPRIVED",# 3 = <  - Q1, these are the most deprived
                                 ifelse(var> summary[2] & var <= summary[3],"2. Second most deprived", #2 = Q1 - <=Median 
                                        ifelse(var > summary[3] &  #1 = #3 = > Median - <= Q3
                                                 var <= summary[5],"3. Second least deprived","4. Least deprived")))) # > Q3



var<-m$ICE_blk_inc_1418
summary<-summary(var)

m$ice_1418_blkcat<-ifelse(is.na(var), NA,
                          ifelse(var>= summary[1] & var<= summary[2],"1. LOW: MOST DEPRIVED",
                                 ifelse(var> summary[2] & var <= summary[3],"2. Second most deprived",
                                        ifelse(var > summary[3] & 
                                                 var <= summary[5],"3. Second least deprived","4. Least deprived"))))


table( m$ice_1418_blkcat, m$holc_grade)


var<-m$ICE_hisp_inc_1317
summary<-summary(var)

m$ice_1317_hispcat<-ifelse(is.na(var), NA,
                           ifelse(var>= summary[1] & var<= summary[2],3,
                                  ifelse(var> summary[2] & var <= summary[3],2,
                                         ifelse(var > summary[3] & 
                                                  var <= summary[5],1,0))))



var<-m$ICE_hisp_inc_1418
summary<-summary(var)

m$ice_1418_hispcat<-ifelse(is.na(var), NA,
                           ifelse(var>= summary[1] & var<= summary[2],0,
                                  ifelse(var> summary[2] & var <= summary[3],1,
                                         ifelse(var > summary[3] & 
                                                  var <= summary[5],2,3))))




m$tree_canopylt25cat<-ifelse(m$tree_canopy_n==0,1,
                             ifelse(m$tree_canopy_n==1,1,0))


m$immature_trees_nonecat<-ifelse(m$immature_trees_n==0,1,0)

#########################################################
### descriptive statistics, 2010 census tracts

#need to get in the population density variable
setwd('W:/UHC/Schinasi_Infant_Mortality/AHA/AHA_Data')

c<-read.csv('env_long.csv')

c<-c[which(c$year=="2016"),]

c<-c[c("geoid10", "popden_km", "race_blackNH")]

m<-merge(m, c, by.x="GEOID10", by.y="geoid10")

library(tableone)

data2<-m[c("GEOID10", "race_blackNH", "race_whiteNH" ,"race_hisp"  , "pov_allage"  ,"Educ_ltHS","popden_km" )]

data2$race_blackNH=data2$race_blackNH*100
data2$race_whiteNH=data2$race_white*100
data2$race_hisp=data2$race_hisp*100
data2$pov_allage=data2$pov_allage*100
data2$Educ_ltHS=data2$Educ_ltHS*100

#get unique census tracts

data3<-unique(data2)

myVars <- names(data3[2:7])

tab3 <- CreateTableOne(vars = myVars, data = data3)

prba<-print(tab3)

tab4 <- CreateTableOne(vars = myVars, data = data3)

prbb<-print(tab4, nonnormal = myVars)

all<-cbind(prba, prbb)
write.csv(all, 'C:/Users/lhs36/OneDrive - Drexel University/Redlining/urban_heat_redlining/results/descr_2010censustractsinventoried.csv')




### Descriptive, all of Philly CTs, for comparison ###
setwd('W:/UHC/Schinasi_Infant_Mortality/AHA/AHA_Data')

c<-read.csv('env_long.csv')

c<-c[which(c$year=="2016"),]

c<-c[c("geoid10", "race_blackNH", "race_whiteNH" ,"race_hisp"  , 
       "pov_allage"  ,"Educ_ltHS","popden_km")]

myVars <- names(c[2:7])

c$race_blackNH=c$race_blackNH*100
c$race_whiteNH=c$race_white*100
c$race_hisp=c$race_hisp*100
c$pov_allage=c$pov_allage*100
c$Educ_ltHS=c$Educ_ltHS*100


tab3 <- CreateTableOne(vars = myVars, data = c)

prba<-print(tab3)

tab4 <- CreateTableOne(vars = myVars, data = c)

prbb<-print(tab4, nonnormal = myVars)

all<-cbind(prba, prbb)
write.csv(all, 'C:/Users/lhs36/OneDrive - Drexel University/Redlining/urban_heat_redlining/results/descr_censustracts2010_allphilly.csv')


## descriptive statistics on the 1940s census tracts
setwd('C:/Users/lhs36/OneDrive - Drexel University/Redlining/urban_heat_redlining/data/1940sDecennialcensus/nhgis0001_csv/nhgis0001_csv')

census<-read.csv('C:/Users/lhs36/OneDrive - Drexel University/Redlining/urban_heat_redlining/data/1940sDecennialcensus/nhgis0004_csv/nhgis0004_csv/nhgis0004_ds76_1940_tract.csv')

census$blk<-as.numeric(census$BVG001)
census$pop<-as.numeric(census$BUB001)
census$wht<-as.numeric(census$BUQ001)
census$medianhomevalue40<-as.numeric(census$BVC001)

census$atleasthighschool40<-as.numeric(census$BUH006)+as.numeric(census$BUH007)+
  as.numeric(census$BUH008)+as.numeric(census$BUH015) +
  as.numeric(census$BUH016)+ as.numeric(census$BUH017)

census$edreported<-
  as.numeric(census$BUH001)+ as.numeric(census$BUH002)+ 
  as.numeric(census$BUH003)+ as.numeric(census$BUH004)+ as.numeric(census$BUH005)+
  as.numeric(census$BUH006)+as.numeric(census$BUH007)+
  as.numeric(census$BUH008) + as.numeric(census$BUH010)+ as.numeric(census$BUH011)+ 
  as.numeric(census$BUH012)+ as.numeric(census$BUH013)+ as.numeric(census$BUH014)+
  as.numeric(census$BUH015)+as.numeric(census$BUH016)+
  as.numeric(census$BUH017) 

census$lthighschool40<-as.numeric(census$BUH001)+ as.numeric(census$BUH002)+ 
  as.numeric(census$BUH003)+ as.numeric(census$BUH004)+ as.numeric(census$BUH005)+
  as.numeric(census$BUH010)+ as.numeric(census$BUH011)+ 
  as.numeric(census$BUH012)+ as.numeric(census$BUH013)+as.numeric(census$BUH014)


census$pctblk40<-(census$blk/census$pop)*100


census$blk40_ice<-(census$wht-census$blk)/(census$pop)

census$highschool40_ice<-(census$atleasthighschool40-census$lthighschool40)/(census$edreported)

census$nonwhite40_ice<-(as.numeric(census$BUQ001)-as.numeric(census$BUQ002)/census$pop)

census$pcthighschool40<-(census$atleasthighschool40/census$edreported)*100

census$pctnonwhite40<-(as.numeric(census$BUQ002)/census$pop)*100


census<-subset(census, COUNTY=="Philadelphia")
census_k<-census[c("GISJOIN",  "pctblk40", 
                   "pctnonwhite40", "blk40_ice", "medianhomevalue40", 
                   "highschool40_ice", "nonwhite40_ice", "pcthighschool40", 'pop')]

### get in the square area of the census tract 
library(sf)
library(tidyverse)
#shape <- readOGR(dsn = "C:/Users/lhs36/Dropbox/Leah Work/Redlining/Philadelphia_data shape file", layer = "Philadelphia_data")

#shape_usa<-readOGR(dsn='C:/Users/lhs36/OneDrive - Drexel University/Redlining/urban_heat_redlining/data/nhgis0003_shapefile_tl2000_us_tract_1940', layer= "US_tract_1940")

phil <- st_read("C:/Users/lhs36/Dropbox/Leah Work/Redlining/Philadelphia_data shape file/Philadelphia_data.shp", stringsAsFactors=FALSE)
phil$area <- st_area(phil)

phil$areakm<-units::set_units(phil$area, km^2)

phil_df<-as.data.frame(phil)
phil_ll <- st_transform(phil, "+proj=longlat +ellps=WGS84 +datum=WGS84")


#convert area to square km


ph_keep<-phil_ll[c("GISJOIN", "areakm")]

c40<-merge(ph_keep, census_k, by="GISJOIN")
c40$popdens40<-c40$pop/c40$areakm

### descriptive stats all of philly 1940

data2<-c40[c("pctblk40"    ,      "pctnonwhite40", "pcthighschool40", "medianhomevalue40" , "popdens40" )]

#get rid of the geography field so can convert to standard data frame

st_drop_geometry <- function(x) {
  if(inherits(x,"sf")) {
    x <- st_set_geometry(x, NULL)
    class(x) <- 'data.frame'
  }
  return(x)
}

data3<-st_drop_geometry(data2)

myVars <- names(data3[1:5])

data3$popdens40<-as.numeric(data3$popdens40)
tab3 <- CreateTableOne(vars = myVars, data = data3)

prba<-print(tab3)

tab4 <- CreateTableOne(vars = myVars, data = data3)

prbb<-print(tab4, nonnormal = myVars)

all<-cbind(prba, prbb)
write.csv(all, 'C:/Users/lhs36/OneDrive - Drexel University/Redlining/urban_heat_redlining/results/descriptive_allphilcensustracts1940.csv')

# merge in with the inventory database to create descriptive stats for census tracts included in analysis

c40_2<-c40[c("popdens40", "GISJOIN")]
m_40<-merge(m, c40_2, by="GISJOIN", all.x=T)
#get unique census tracts



m40k<-m_40[c("GISJOIN", "pctblk40"    ,  "pctnonwhite40", "pcthighschool40", "medianhomevalue40" , "popdens40" )]
m40k$popdens40<-as.numeric(m40k$popdens40)

data3<-unique(m40k)

myVars <- names(data3[2:6])

tab3 <- CreateTableOne(vars = myVars, data = data3)

prba<-print(tab3)

tab4 <- CreateTableOne(vars = myVars, data = data3)

prbb<-print(tab4, nonnormal = myVars)

all<-cbind(prba, prbb)
write.csv(all, 'C:/Users/lhs36/OneDrive - Drexel University/Redlining/urban_heat_redlining/results/descriptive_censustracts1940.csv')
########################################

data2<-m[c('holc_grade',
          'ice_1418_hispcat',
          'ice_1418_blkcat',
           'tree_canopylt25cat',
           'immature_trees_nonecat',
           'roof_flat_dark',
           'roof_flat_n',
           'dark_roof_n',
           'airc_none',
           'Central_Aiyn')]


myVars <- catVars <- names(data2)

tab3 <- CreateTableOne(vars = myVars, strata = "holc_grade" , data = data2, factorVars = catVars)

prb<-print(tab3,  showAllLevels = F)

write.csv(prb, 'C:/Users/lhs36/OneDrive - Drexel University/Redlining/urban_heat_redlining/results/descriptive_by_holcgrade.csv')

############





library(tableone)


data2<-m[c('ice_1418_blkcat',
           'tree_canopylt25cat',
           'immature_trees_nonecat',
           'roof_flat_dark',
           'roof_flat_n',
           'dark_roof_n',
           'airc_none',
           'Central_Aiyn')]


myVars <- catVars <- names(data2[2:8])

tab3 <- CreateTableOne(vars = myVars, strata = "ice_1418_blkcat" , data = data2, factorVars = catVars)

prb<-print(tab3, format='f', showAllLevels = F)

write.csv(prb, 'C:/Users/lhs36/OneDrive - Drexel University/Redlining/urban_heat_redlining/results/housingcnts_by_ice_1418_blkcat.csv.csv')


#############

data2<-m[c('ice_1418_hispcat',
           'tree_canopylt25cat',
           'immature_trees_nonecat',
           'roof_flat_dark',
           'roof_flat_n',
           'dark_roof_n',
           'airc_none',
           'Central_Aiyn')]


myVars <- catVars <- names(data2[2:8])

tab3 <- CreateTableOne(vars = myVars, strata = "ice_1418_hispcat" , data = data2, factorVars = catVars)

prb<-print(tab3,  format= 'f', showAllLevels = F)

write.csv(prb, 'C:/Users/lhs36/OneDrive - Drexel University/Redlining/urban_heat_redlining/results/housingcnts_by_ice_1418_hispcat.csv.csv')


##############################################




