
setwd("C:/Users/lhs36/OneDrive - Drexel University/Redlining/urban_heat_redlining/results")

library(forestplot)

#######################################################################

data<-read.csv('20211115_modelA.crude_HOLCreg.csv')

data$label= c("Low or no mature tree canopy", "No immature trees", "Flat, dark roof", "Flat roof", "Dark roof", "No air conditioning", "No central air conditioning")

colnames(data)<-c("X", "Outcome", "B", "LL", "UL", "C", "LL2", "UL2", "D", "LL3", "UL3", "label")

#Then format the data a bit so that the column labels 
#and columns match the required graphical output:

library(reshape)
library(tidyr)

#reshape the data and prepare for illustration in the forest plot

keycol <- "grade"
valuecol1 <- "RR"
valuecol2<-"LL"
valuecol3<-"UL"
gathercols1 <-c("B", "C", "D") 
gathercols2<-c("LL", "LL2", "LL3")
gathercols3<-c("UL", "UL2", "UL3")

dpw1<-gather_(data, keycol, valuecol1, gathercols1)
dpw2<-gather_(data, keycol, valuecol2, gathercols2)
dpw3<-gather_(data, keycol, valuecol3, gathercols3)

dpw1<-dpw1[c("grade", "Outcome", "RR")]
dpw2<-dpw2[c("grade", "Outcome", "LL")]
dpw3<-dpw3[c("grade", "Outcome", "UL", "label")]

dpw<-cbind(dpw1, dpw2, dpw3)

dpw<-dpw[c(1, 2, 3, 6, 9, 10)]


# add in header rows

reg<-dpw

# create a database with the A grades coded
ll<-names(as.list(table(reg$Outcome)))
lll<-names(as.list(table(reg$label)))

add_these<-data.frame (grade  = c("A", "A", "A", "A", "A", "A", "A"),
                             Outcome = c(NA,NA,NA,NA,NA,NA,NA),
                            RR=c(1,1,1,1,1,1,1),
                            LL=c(NA,NA,NA,NA,NA,NA,NA),
                            UL=c(NA,NA,NA,NA,NA,NA,NA),
                            label=lll)
                       
reg<-rbind(add_these, reg)

reg<-reg[order(  reg$label, reg$grade),]

#input the count data to add

counts<-read.csv("20211115_counts_by_holc_complete.csv")

counts<-counts[2:8,]

counts$label= c("Low or no mature tree canopy", "No immature trees", "Flat, dark roof", "Flat roof", "Dark roof", "No air conditioning", "No central air conditioning")

#reshape the data and prepare for illustration in the forest plot

keycol <- "grade"
valuecol1 <- "count"
gathercols1 <-c("A", "B", "C", "D") 

dpw1<-gather_(counts, keycol, valuecol1, gathercols1)

dpw1<-dpw1[c("grade", "count", "label")]

dpw1<-dpw1[order(  dpw1$label, dpw1$grade),]

dpw2<-merge(dpw1, reg, by=c("grade", "label"))

dpw2<-dpw2[order(  dpw2$label, dpw2$grade),]

library(tidyverse)
dpw3<-add_row(dpw2, grade =NA, Outcome = NA, RR =NA,  LL=NA, UL=NA,count=NA, label= "Dark roof" , .before =1 )
dpw4<-add_row(dpw3, grade =NA, Outcome = NA, RR =NA,  LL=NA, UL=NA,count=NA, label= "Flat roof" , .before =6 )
dpw5<-add_row(dpw4, grade =NA, Outcome = NA, RR =NA,  LL=NA, UL=NA,count=NA, label= "Flat, dark roof" , .before =11 )
dpw6<-add_row(dpw5, grade =NA, Outcome = NA, RR =NA,  LL=NA, UL=NA,count=NA, label= "Low or no mature tree canopy" , .before =16 )
dpw7<-add_row(dpw6, grade =NA, Outcome = NA, RR =NA,  LL=NA, UL=NA,count=NA, label= "No air conditioning" , .before =16+5)
dpw8<-add_row(dpw7, grade =NA, Outcome = NA, RR =NA,  LL=NA, UL=NA,count=NA, label= "No central air conditioning" , .before =16+5+5)
dpw9<-add_row(dpw8, grade =NA, Outcome = NA, RR =NA,  LL=NA, UL=NA,count=NA, label= "No immature trees" , .before =16+5+5+5)


d<-dpw9
vals<-which(d$grade %in% c("A", "B", "C", "D"))   
subgps <- vals
d$grade<-ifelse(is.na(d$grade), d$label, d$grade)
d$grade[subgps] <- paste("  ",d$grade[subgps]) 

d<-d[which(d$label != "No central air conditioning"),]
d<-d[which(d$label != "No air conditioning"),]

d$RR<-as.numeric(formatC(as.numeric(d$RR), digits = 3, drop0trailing = FALSE))
d$LL<-as.numeric(formatC(as.numeric(d$LL), digits = 3, drop0trailing = FALSE))
d$UL<-as.numeric(formatC(as.numeric(d$UL), digits = 3, drop0trailing = FALSE))

d$RRf<-sprintf("%.2f", round(d$RR,3))
d$LLf<-sprintf("%.2f", round(d$LL,3))
d$ULf<-sprintf("%.2f", round(d$UL,3))

orc<-paste(d$RRf, "(", d$LLf, " - ",  d$ULf, ")")

orc<-ifelse(orc=="NA ( NA  -  NA )", "", 
            ifelse(orc=="1.00 ( NA  -  NA )", "REF", orc))
            
## The rest of the columns in the table. 

tabletext <- cbind(c(" ","\n",d$grade),
                   c("N","\n", d$count),
                   c("RR (95% CI)","\n",  orc))

png("20211115_modelA.forest.png",width=960, height=640)

forestplot(labeltext=tabletext, graph.pos=2, 
           mean=c(NA, NA, d$RR), 
           lower=c(NA, NA, d$LL),
           upper=c(NA, NA, d$UL),
           title="Risk ratio (95% CI)",
           txt_gp=fpTxtGp(label=gpar(cex=1.25),
                          ticks=gpar(cex=1.1),
                          # xlab=gpar(cex = 1.2),
                          title=gpar(cex = 1.2)),
           
           col=fpColors(box="black", lines="black", zero = "gray50"),
           zero=1, cex=0.9, lineheight = "auto", boxsize=0.5, 
           colgap=unit(6,"mm"),
           lwd.ci=2, ci.vertices=TRUE, ci.vertices.height = 0.4)
dev.off()

### Model adjusted for 1940s SEP & RACE ###

data<-read.csv('20211115_modelDD.HOLCadj_racesepice40.csv')

data$label= c("Low or no mature tree canopy", "No immature trees", "Flat, dark roof", "Flat roof", "Dark roof", "No air conditioning", "No central air conditioning")

colnames(data)<-c("X", "Outcome", "B", "LL", "UL", "C", "LL2", "UL2", "D", "LL3", "UL3", "label")

#Then format the data a bit so that the column labels 
#and columns match the required graphical output:

library(reshape)
library(tidyr)

#reshape the data and prepare for illustration in the forest plot

keycol <- "grade"
valuecol1 <- "RR"
valuecol2<-"LL"
valuecol3<-"UL"
gathercols1 <-c("B", "C", "D") 
gathercols2<-c("LL", "LL2", "LL3")
gathercols3<-c("UL", "UL2", "UL3")

dpw1<-gather_(data, keycol, valuecol1, gathercols1)
dpw2<-gather_(data, keycol, valuecol2, gathercols2)
dpw3<-gather_(data, keycol, valuecol3, gathercols3)

dpw1<-dpw1[c("grade", "Outcome", "RR")]
dpw2<-dpw2[c("grade", "Outcome", "LL")]
dpw3<-dpw3[c("grade", "Outcome", "UL", "label")]

dpw<-cbind(dpw1, dpw2, dpw3)

dpw<-dpw[c(1, 2, 3, 6, 9, 10)]


# add in header rows

reg<-dpw

# create a database with the A grades coded
ll<-names(as.list(table(reg$Outcome)))
lll<-names(as.list(table(reg$label)))

add_these<-data.frame (grade  = c("A", "A", "A", "A", "A", "A", "A"),
                       Outcome = c(NA,NA,NA,NA,NA,NA,NA),
                       RR=c(1,1,1,1,1,1,1),
                       LL=c(NA,NA,NA,NA,NA,NA,NA),
                       UL=c(NA,NA,NA,NA,NA,NA,NA),
                       label=lll)

reg<-rbind(add_these, reg)

reg<-reg[order(  reg$label, reg$grade),]

#input the count data to add

counts<-read.csv("20211115_counts_by_holc_ice40complete.csv")
counts<-counts[2:8,]
counts$label= c("Low or no mature tree canopy", "No immature trees", "Flat, dark roof", "Flat roof", "Dark roof", "No air conditioning", "No central air conditioning")

#reshape the data and prepare for illustration in the forest plot

keycol <- "grade"
valuecol1 <- "count"
gathercols1 <-c("A", "B", "C", "D") 

dpw1<-gather_(counts, keycol, valuecol1, gathercols1)

dpw1<-dpw1[c("grade", "count", "label")]

dpw1<-dpw1[order(  dpw1$label, dpw1$grade),]

dpw2<-merge(dpw1, reg, by=c("grade", "label"))

dpw2<-dpw2[order(  dpw2$label, dpw2$grade),]

library(tidyverse)
dpw3<-add_row(dpw2, grade =NA, Outcome = NA, RR =NA,  LL=NA, UL=NA,count=NA, label= "Dark roof" , .before =1 )
dpw4<-add_row(dpw3, grade =NA, Outcome = NA, RR =NA,  LL=NA, UL=NA,count=NA, label= "Flat roof" , .before =6 )
dpw5<-add_row(dpw4, grade =NA, Outcome = NA, RR =NA,  LL=NA, UL=NA,count=NA, label= "Flat, dark roof" , .before =11 )
dpw6<-add_row(dpw5, grade =NA, Outcome = NA, RR =NA,  LL=NA, UL=NA,count=NA, label= "Low or no mature tree canopy" , .before =16 )
dpw7<-add_row(dpw6, grade =NA, Outcome = NA, RR =NA,  LL=NA, UL=NA,count=NA, label= "No air conditioning" , .before =16+5)
dpw8<-add_row(dpw7, grade =NA, Outcome = NA, RR =NA,  LL=NA, UL=NA,count=NA, label= "No central air conditioning" , .before =16+5+5)
dpw9<-add_row(dpw8, grade =NA, Outcome = NA, RR =NA,  LL=NA, UL=NA,count=NA, label= "No immature trees" , .before =16+5+5+5)


d<-dpw9
vals<-which(d$grade %in% c("A", "B", "C", "D"))   
subgps <- vals
d$grade<-ifelse(is.na(d$grade), d$label, d$grade)
d$grade[subgps] <- paste("  ",d$grade[subgps]) 

d<-d[which(d$label != "No central air conditioning"),]
d<-d[which(d$label != "No air conditioning"),]

d$RR<-as.numeric(formatC(as.numeric(d$RR), digits = 3, drop0trailing = FALSE))
d$LL<-as.numeric(formatC(as.numeric(d$LL), digits = 3, drop0trailing = FALSE))
d$UL<-as.numeric(formatC(as.numeric(d$UL), digits = 3, drop0trailing = FALSE))

d$RRf<-sprintf("%.2f", round(d$RR,3))
d$LLf<-sprintf("%.2f", round(d$LL,3))
d$ULf<-sprintf("%.2f", round(d$UL,3))

orc<-paste(d$RRf, "(", d$LLf, " - ",  d$ULf, ")")

orc<-ifelse(orc=="NA ( NA  -  NA )", "", 
            ifelse(orc=="1.00 ( NA  -  NA )", "REF", orc))

## The rest of the columns in the table. 

tabletext <- cbind(c(" ","\n",d$grade),
                   c("N","\n", d$count),
                   c("RR (95% CI)","\n",  orc))

png("C:/Users/lhs36/OneDrive - Drexel University/Redlining/urban_heat_redlining/results/20211115_modelDD_adjhistoricblkice_sep.forest.png",width=960, height=640)

forestplot(labeltext=tabletext, graph.pos=2, 
           mean=c(NA, NA, d$RR), 
           lower=c(NA, NA, d$LL),
           upper=c(NA, NA, d$UL),
           title="Risk ratio (95% CI)",
           txt_gp=fpTxtGp(label=gpar(cex=1.25),
                          ticks=gpar(cex=1.1),
                          # xlab=gpar(cex = 1.2),
                          title=gpar(cex = 1.2)),
           
           col=fpColors(box="black", lines="black", zero = "gray50"),
           zero=1, cex=0.9, lineheight = "auto", boxsize=0.5, 
           colgap=unit(6,"mm"),
           lwd.ci=2, ci.vertices=TRUE, ci.vertices.height = 0.4)
dev.off()

#######################################################

### MODEL E. Adjust for present-day ICE

data<-read.csv('20211115_modelE.HOLC_adjblkice1418.csv')

data$label= c("Low or no mature tree canopy", "No immature trees", "Flat, dark roof", "Flat roof", "Dark roof", "No air conditioning", "No central air conditioning")

colnames(data)<-c("X", "Outcome", "B", "LL", "UL", "C", "LL2", "UL2", "D", "LL3", "UL3", "label")

#Then format the data a bit so that the column labels 
#and columns match the required graphical output:

library(reshape)
library(tidyr)

#reshape the data and prepare for illustration in the forest plot

keycol <- "grade"
valuecol1 <- "RR"
valuecol2<-"LL"
valuecol3<-"UL"
gathercols1 <-c("B", "C", "D") 
gathercols2<-c("LL", "LL2", "LL3")
gathercols3<-c("UL", "UL2", "UL3")

dpw1<-gather_(data, keycol, valuecol1, gathercols1)
dpw2<-gather_(data, keycol, valuecol2, gathercols2)
dpw3<-gather_(data, keycol, valuecol3, gathercols3)

dpw1<-dpw1[c("grade", "Outcome", "RR")]
dpw2<-dpw2[c("grade", "Outcome", "LL")]
dpw3<-dpw3[c("grade", "Outcome", "UL", "label")]

dpw<-cbind(dpw1, dpw2, dpw3)

dpw<-dpw[c(1, 2, 3, 6, 9, 10)]


# add in header rows

reg<-dpw

# create a database with the A grades coded
ll<-names(as.list(table(reg$Outcome)))
lll<-names(as.list(table(reg$label)))

add_these<-data.frame (grade  = c("A", "A", "A", "A", "A", "A", "A"),
                       Outcome = c(NA,NA,NA,NA,NA,NA,NA),
                       RR=c(1,1,1,1,1,1,1),
                       LL=c(NA,NA,NA,NA,NA,NA,NA),
                       UL=c(NA,NA,NA,NA,NA,NA,NA),
                       label=lll)

reg<-rbind(add_these, reg)

reg<-reg[order(  reg$label, reg$grade),]

#input the count data to add

counts<-read.csv("20211115_counts_by_holc_complete.csv")

counts<-counts[2:8,]

counts$label= c("Low or no mature tree canopy", "No immature trees", "Flat, dark roof", "Flat roof", "Dark roof", "No air conditioning", "No central air conditioning")

#reshape the data and prepare for illustration in the forest plot

keycol <- "grade"
valuecol1 <- "count"
gathercols1 <-c("A", "B", "C", "D") 

dpw1<-gather_(counts, keycol, valuecol1, gathercols1)

dpw1<-dpw1[c("grade", "count", "label")]

dpw1<-dpw1[order(  dpw1$label, dpw1$grade),]

dpw2<-merge(dpw1, reg, by=c("grade", "label"))

dpw2<-dpw2[order(  dpw2$label, dpw2$grade),]

library(tidyverse)
dpw3<-add_row(dpw2, grade =NA, Outcome = NA, RR =NA,  LL=NA, UL=NA,count=NA, label= "Dark roof" , .before =1 )
dpw4<-add_row(dpw3, grade =NA, Outcome = NA, RR =NA,  LL=NA, UL=NA,count=NA, label= "Flat roof" , .before =6 )
dpw5<-add_row(dpw4, grade =NA, Outcome = NA, RR =NA,  LL=NA, UL=NA,count=NA, label= "Flat, dark roof" , .before =11 )
dpw6<-add_row(dpw5, grade =NA, Outcome = NA, RR =NA,  LL=NA, UL=NA,count=NA, label= "Low or no mature tree canopy" , .before =16 )
dpw7<-add_row(dpw6, grade =NA, Outcome = NA, RR =NA,  LL=NA, UL=NA,count=NA, label= "No air conditioning" , .before =16+5)
dpw8<-add_row(dpw7, grade =NA, Outcome = NA, RR =NA,  LL=NA, UL=NA,count=NA, label= "No central air conditioning" , .before =16+5+5)
dpw9<-add_row(dpw8, grade =NA, Outcome = NA, RR =NA,  LL=NA, UL=NA,count=NA, label= "No immature trees" , .before =16+5+5+5)


d<-dpw9
vals<-which(d$grade %in% c("A", "B", "C", "D"))   
subgps <- vals
d$grade<-ifelse(is.na(d$grade), d$label, d$grade)
d$grade[subgps] <- paste("  ",d$grade[subgps]) 

d<-d[which(d$label != "No central air conditioning"),]
d<-d[which(d$label != "No air conditioning"),]

d$RR<-as.numeric(formatC(as.numeric(d$RR), digits = 3, drop0trailing = FALSE))
d$LL<-as.numeric(formatC(as.numeric(d$LL), digits = 3, drop0trailing = FALSE))
d$UL<-as.numeric(formatC(as.numeric(d$UL), digits = 3, drop0trailing = FALSE))

d$RRf<-sprintf("%.2f", round(d$RR,3))
d$LLf<-sprintf("%.2f", round(d$LL,3))
d$ULf<-sprintf("%.2f", round(d$UL,3))

orc<-paste(d$RRf, "(", d$LLf, " - ",  d$ULf, ")")

orc<-ifelse(orc=="NA ( NA  -  NA )", "", 
            ifelse(orc=="1.00 ( NA  -  NA )", "REF", orc))

## The rest of the columns in the table. 

tabletext <- cbind(c(" ","\n",d$grade),
                   c("N","\n", d$count),
                   c("RR (95% CI)","\n",  orc))

png("C:/Users/lhs36/OneDrive - Drexel University/Redlining/urban_heat_redlining/results/20211115_modelE_moderniceadjustforest.png",width=960, height=640)

forestplot(labeltext=tabletext, 
           graph.pos=2, 
           mean=c(NA, NA, d$RR), 
           lower=c(NA, NA, d$LL),
           upper=c(NA, NA, d$UL),
           title="Risk ratio (95% CI)",
           txt_gp=fpTxtGp(label=gpar(cex=1.25),
                          ticks=gpar(cex=1.1),
                          # xlab=gpar(cex = 1.2),
                          title=gpar(cex = 1.2)),
           
           col=fpColors(box="black", lines="black", zero = "gray50"),
          zero = 1, cex=0.9, lineheight = "auto", boxsize=0.5, 
           colgap=unit(6,"mm"),
           lwd.ci=2, ci.vertices=TRUE, ci.vertices.height = 0.4)
dev.off()


#####



