
library(broom)
library(tidyr)
library(lme4)
library(geepack)
library(tableone)
#set the woring directory
setwd ('C:/Users/lhs36/OneDrive - Drexel University/Redlining/urban_heat_redlining/data')

#view the files in the working directory
list.files()

#read in the data

#p_holc_v<-read.csv("holc_parcels_census.csv")

#census1940<-read.csv("inventoriedparcels_1940scensus.csv")

p_holc_v<-read.csv('p_holc_v_census1940new3.csv')
m<-p_holc_v

m$tree_canopylt25cat<-ifelse(m$tree_canopy_n==0,1,
                             ifelse(m$tree_canopy_n==1,1,0))


m$immature_trees_nonecat<-ifelse(m$immature_trees_n==0,1,0)


m$holc_gradecat<-ifelse(m$holc_grade=="A", 1,
                        ifelse(m$holc_grade=="B", 2,
                               ifelse(m$holc_grade=="C", 3,4)))



ss<-summary(m$sep_sum_40)
#Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's 
# -7.127  -5.606  -2.399  -2.354   0.693   8.483       1 
m$sep_sum_40cat<-ifelse( m$sep_sum_40 < -2.399, 0,
                               ifelse(m$sep_sum_40 >= -2.399 & m$sep_sum_40 < 0.693,1,2))


sb<-summary(m$blk40_ice)

m$blk40_icecat<-ifelse( m$blk40_ice < 0.975, 1,
                               ifelse(m$blk40_ice >= 0.975 & m$blk40_ice < 0.998,2,3))


#sort by geoid10 
m <- m[order(m$GEOID10),]

#CRUDE ASSOCIATION: HOLC & housing 

data<-m[c('holc_gradecat',
          'tree_canopylt25cat',
          'immature_trees_nonecat',
          'roof_flat_dark',
          'roof_flat_n',
          'dark_roof_n',
          'airc_none',
          'Central_Aiyn', 
          'GEOID10',
         'highschool40_ice',
          'medianhomevalue40',
          'blk40_ice',
         'sep_sum_40',
         'blk40_icecat',
         'sep_sum_40cat')]

out_start=2
out_end= 8
out_nvar=out_end-out_start+1
out_variable=rep(NA, out_nvar)

out_beta1=rep(NA, out_nvar)
out_se1 = rep(NA, out_nvar)
out_beta2=rep(NA, out_nvar)
out_se2 = rep(NA, out_nvar)
out_beta3=rep(NA, out_nvar)
out_se3 = rep(NA, out_nvar)

rr1 = rep(NA, out_nvar)
ll1 = rep(NA, out_nvar)
ul1 = rep(NA, out_nvar)

rr2 = rep(NA, out_nvar)
ll2 = rep(NA, out_nvar)
ul2 = rep(NA, out_nvar)

rr3 = rep(NA, out_nvar)
ll3 = rep(NA, out_nvar)
ul3 = rep(NA, out_nvar)

number=1
for (i in out_start:out_end){
  
  outcome = colnames(data)[i]
  
  model <- geeglm(get(outcome) ~as.factor(holc_gradecat), family= poisson(link = "log"), data=data,
                  id      = GEOID10,
                  corstr  = "exchangeable")
  
  out_beta1[number] = summary(model)$coefficients[2,1]
  out_se1[number]  = summary(model)$coefficients[2,2]
  rr1[number] = exp(summary(model)$coefficients[2,1])
  ll1[number] = exp(summary(model)$coefficients[2,1] - (1.96*summary(model)$coefficients[2,2]))
  ul1[number] = exp(summary(model)$coefficients[2,1] + (1.96*summary(model)$coefficients[2,2]))
  
  
  out_beta2[number]  = summary(model)$coefficients[3,1]
  out_se2[number]  = summary(model)$coefficients[3,2]
  rr2[number] = exp(summary(model)$coefficients[3,1])
  ll2[number] = exp(summary(model)$coefficients[3,1] - (1.96*summary(model)$coefficients[3,2]))
  ul2[number] = exp(summary(model)$coefficients[3,1] + (1.96*summary(model)$coefficients[3,2]))
  
  out_beta3[number]  = summary(model)$coefficients[4,1]
  out_se3[number]  = summary(model)$coefficients[4,2]
  rr3[number] = exp(summary(model)$coefficients[4,1])
  ll3[number] = exp(summary(model)$coefficients[4,1] - (1.96*summary(model)$coefficients[4,2]))
  ul3[number] = exp(summary(model)$coefficients[4,1] + (1.96*summary(model)$coefficients[4,2]))
  
  out_variable[number] = outcome
  
  number = number + 1
  
}

#merge together all the results data frames
results<-data.frame(out_variable, out_beta1, out_se1,out_beta2, out_se2,out_beta3, out_se3,
                    rr1, ll1, ul1, rr2, ll2,ul2, rr3, ll3, ul3)


#round results
results2= data.frame(out_variable, round(results[2:16], 3))

results3<-results2[c(1, 8:16)]


#rename column names
colnames(results3)<-c("Outcome", "Grade B RR ", "Grade B  LL", "Grade B  UL",
                      "Grade C RR", "Grade C  LL", "Grade C  UL",
                      "Grade D RR ", "Grade D LL", "Grade D UL")

results4<-rapply(object = results3, f = round, classes = "numeric",
                 how = "replace", digits = 2) 


write.csv(results4, "C:/Users/lhs36/OneDrive - Drexel University/Redlining/urban_heat_redlining/results/20211115_modelA.crude_HOLCreg.csv")

#############Adjust for SE Index (1940) & Blk ICE variable

#One property is missing SE Index data so delete this 


data<-na.omit(data)

number = 1

for (i in out_start:out_end){
  
  outcome = colnames(data)[i]
  
  model <- geeglm(get(outcome) ~as.factor(holc_gradecat) + 
                    (blk40_ice) + (sep_sum_40),
                  family= poisson(link = "log"), data=data,
                  id      = GEOID10,
                  corstr  = "exchangeable")
  
  out_beta1[number] = summary(model)$coefficients[2,1]
  out_se1[number]  = summary(model)$coefficients[2,2]
  rr1[number] = exp(summary(model)$coefficients[2,1])
  ll1[number] = exp(summary(model)$coefficients[2,1] - (1.96*summary(model)$coefficients[2,2]))
  ul1[number] = exp(summary(model)$coefficients[2,1] + (1.96*summary(model)$coefficients[2,2]))
  
  
  out_beta2[number]  = summary(model)$coefficients[3,1]
  out_se2[number]  = summary(model)$coefficients[3,2]
  rr2[number] = exp(summary(model)$coefficients[3,1])
  ll2[number] = exp(summary(model)$coefficients[3,1] - (1.96*summary(model)$coefficients[3,2]))
  ul2[number] = exp(summary(model)$coefficients[3,1] + (1.96*summary(model)$coefficients[3,2]))
  
  out_beta3[number]  = summary(model)$coefficients[4,1]
  out_se3[number]  = summary(model)$coefficients[4,2]
  rr3[number] = exp(summary(model)$coefficients[4,1])
  ll3[number] = exp(summary(model)$coefficients[4,1] - (1.96*summary(model)$coefficients[4,2]))
  ul3[number] = exp(summary(model)$coefficients[4,1] + (1.96*summary(model)$coefficients[4,2]))
  
  out_variable[number] = outcome
  
  number = number + 1
  
}

#merge together all the results data frames
results<-data.frame(out_variable, out_beta1, out_se1,out_beta2, out_se2,out_beta3, out_se3,
                    rr1, ll1, ul1, rr2, ll2,ul2, rr3, ll3, ul3)



#round results
results2= data.frame(out_variable, round(results[2:16], 3))

results3<-results2[c(1, 8:16)]


#rename column names
colnames(results3)<-c("Outcome", "Grade B RR ", "Grade B  LL", "Grade B  UL",
                      "Grade C RR", "Grade C  LL", "Grade C  UL",
                      "Grade D RR ", "Grade D LL", "Grade D UL")

results4<-rapply(object = results3, f = round, classes = "numeric",
                 how = "replace", digits = 2) 



write.csv(results4, "C:/Users/lhs36/OneDrive - Drexel University/Redlining/urban_heat_redlining/results/20211115_modelDD.HOLCadj_racesepice40.csv")


########## MODEL E. HOLC adjusted for present-day ICE

data<-m[c('holc_gradecat',
          'tree_canopylt25cat',
          'immature_trees_nonecat',
          'roof_flat_dark',
          'roof_flat_n',
          'dark_roof_n',
          'airc_none',
          'Central_Aiyn', 
          'GEOID10',
          'highschool40_ice',
          'medianhomevalue40',
          'ice_1418_blkcat',
          'ICE_blk_inc_1418')]

out_start=2
out_end= 8
out_nvar=out_end-out_start+1
out_variable=rep(NA, out_nvar)

out_beta1=rep(NA, out_nvar)
out_se1 = rep(NA, out_nvar)
out_beta2=rep(NA, out_nvar)
out_se2 = rep(NA, out_nvar)
out_beta3=rep(NA, out_nvar)
out_se3 = rep(NA, out_nvar)

rr1 = rep(NA, out_nvar)
ll1 = rep(NA, out_nvar)
ul1 = rep(NA, out_nvar)

rr2 = rep(NA, out_nvar)
ll2 = rep(NA, out_nvar)
ul2 = rep(NA, out_nvar)

rr3 = rep(NA, out_nvar)
ll3 = rep(NA, out_nvar)
ul3 = rep(NA, out_nvar)

number=1
for (i in out_start:out_end){
  
  outcome = colnames(data)[i]
  
  model <- geeglm(get(outcome) ~as.factor(holc_gradecat) + ICE_blk_inc_1418, 
                  family= poisson(link = "log"), data=data,
                  id      = GEOID10,
                  corstr  = "exchangeable")
  
  out_beta1[number] = summary(model)$coefficients[2,1]
  out_se1[number]  = summary(model)$coefficients[2,2]
  rr1[number] = exp(summary(model)$coefficients[2,1])
  ll1[number] = exp(summary(model)$coefficients[2,1] - (1.96*summary(model)$coefficients[2,2]))
  ul1[number] = exp(summary(model)$coefficients[2,1] + (1.96*summary(model)$coefficients[2,2]))
  
  
  out_beta2[number]  = summary(model)$coefficients[3,1]
  out_se2[number]  = summary(model)$coefficients[3,2]
  rr2[number] = exp(summary(model)$coefficients[3,1])
  ll2[number] = exp(summary(model)$coefficients[3,1] - (1.96*summary(model)$coefficients[3,2]))
  ul2[number] = exp(summary(model)$coefficients[3,1] + (1.96*summary(model)$coefficients[3,2]))
  
  out_beta3[number]  = summary(model)$coefficients[4,1]
  out_se3[number]  = summary(model)$coefficients[4,2]
  rr3[number] = exp(summary(model)$coefficients[4,1])
  ll3[number] = exp(summary(model)$coefficients[4,1] - (1.96*summary(model)$coefficients[4,2]))
  ul3[number] = exp(summary(model)$coefficients[4,1] + (1.96*summary(model)$coefficients[4,2]))
  
  out_variable[number] = outcome
  
  number = number + 1
  
}

#merge together all the results data frames
results<-data.frame(out_variable, out_beta1, out_se1,out_beta2, out_se2,out_beta3, out_se3,
                    rr1, ll1, ul1, rr2, ll2,ul2, rr3, ll3, ul3)


#round results
results2= data.frame(out_variable, round(results[2:16], 3))

results3<-results2[c(1, 8:16)]


#rename column names
colnames(results3)<-c("Outcome", "Grade B RR ", "Grade B  LL", "Grade B  UL",
                      "Grade C RR", "Grade C  LL", "Grade C  UL",
                      "Grade D RR ", "Grade D LL", "Grade D UL")

results4<-rapply(object = results3, f = round, classes = "numeric",
                 how = "replace", digits = 2) 


write.csv(results4, "C:/Users/lhs36/OneDrive - Drexel University/Redlining/urban_heat_redlining/results/20211115_modelE.HOLC_adjblkice1418.csv")


## Sensitivity: Change cluster variable to GIS JOIN

m <- m[order(m$GISJOIN),]

data<-m[c('holc_gradecat',
          'tree_canopylt25cat',
          'immature_trees_nonecat',
          'roof_flat_dark',
          'roof_flat_n',
          'dark_roof_n',
          'airc_none',
          'Central_Aiyn', 
          'GISJOIN',
          'highschool40_ice',
          'medianhomevalue40',
          'blk40_ice')]

out_start=2
out_end= 8
out_nvar=out_end-out_start+1
out_variable=rep(NA, out_nvar)

out_beta1=rep(NA, out_nvar)
out_se1 = rep(NA, out_nvar)
out_beta2=rep(NA, out_nvar)
out_se2 = rep(NA, out_nvar)
out_beta3=rep(NA, out_nvar)
out_se3 = rep(NA, out_nvar)

rr1 = rep(NA, out_nvar)
ll1 = rep(NA, out_nvar)
ul1 = rep(NA, out_nvar)

rr2 = rep(NA, out_nvar)
ll2 = rep(NA, out_nvar)
ul2 = rep(NA, out_nvar)

rr3 = rep(NA, out_nvar)
ll3 = rep(NA, out_nvar)
ul3 = rep(NA, out_nvar)

number=1
for (i in out_start:out_end){
  
  outcome = colnames(data)[i]
  
  model <- geeglm(get(outcome) ~as.factor(holc_gradecat), family= poisson(link = "log"), data=data,
                  id      = as.factor(GISJOIN),
                  corstr  = "exchangeable")
  
  out_beta1[number] = summary(model)$coefficients[2,1]
  out_se1[number]  = summary(model)$coefficients[2,2]
  rr1[number] = exp(summary(model)$coefficients[2,1])
  ll1[number] = exp(summary(model)$coefficients[2,1] - (1.96*summary(model)$coefficients[2,2]))
  ul1[number] = exp(summary(model)$coefficients[2,1] + (1.96*summary(model)$coefficients[2,2]))
  
  
  out_beta2[number]  = summary(model)$coefficients[3,1]
  out_se2[number]  = summary(model)$coefficients[3,2]
  rr2[number] = exp(summary(model)$coefficients[3,1])
  ll2[number] = exp(summary(model)$coefficients[3,1] - (1.96*summary(model)$coefficients[3,2]))
  ul2[number] = exp(summary(model)$coefficients[3,1] + (1.96*summary(model)$coefficients[3,2]))
  
  out_beta3[number]  = summary(model)$coefficients[4,1]
  out_se3[number]  = summary(model)$coefficients[4,2]
  rr3[number] = exp(summary(model)$coefficients[4,1])
  ll3[number] = exp(summary(model)$coefficients[4,1] - (1.96*summary(model)$coefficients[4,2]))
  ul3[number] = exp(summary(model)$coefficients[4,1] + (1.96*summary(model)$coefficients[4,2]))
  
  out_variable[number] = outcome
  
  number = number + 1
  
}

#merge together all the results data frames
results<-data.frame(out_variable, out_beta1, out_se1,out_beta2, out_se2,out_beta3, out_se3,
                    rr1, ll1, ul1, rr2, ll2,ul2, rr3, ll3, ul3)


#round results
results2= data.frame(out_variable, round(results[2:16], 3))

results3<-results2[c(1, 8:16)]


#rename column names
colnames(results3)<-c("Outcome", "Grade B RR ", "Grade B  LL", "Grade B  UL",
                      "Grade C RR", "Grade C  LL", "Grade C  UL",
                      "Grade D RR ", "Grade D LL", "Grade D UL")

results4<-rapply(object = results3, f = round, classes = "numeric",
                 how = "replace", digits = 2) 


write.csv(results4, "C:/Users/lhs36/OneDrive - Drexel University/Redlining/urban_heat_redlining/results/20210629_sensmodelA.crude_HOLC_gisjoincluster.csv")


# Reviewer comment: Interested in analyses stratified by present-day ICE

s<-summary(m$ICE_blk_inc_1418)
v<-m$ICE_blk_inc_1418
#     Min. 1st Qu.  Median  Mean  3rd Qu.   Max. 
#-0.6287 -0.3728  0.1450 -0.0132  0.3061  0.5276 

m$ice1418cat<-ifelse(v > s[5],1,
                     ifelse(v <= s[5] & v > s[3], 2,
                            ifelse( v <= s[3] & v > s[2],3,4)))
                                    
#Not enough exposure contrasts to do this stratification
# try adjusting for this categorical version of ice1418cat


data<-m[c('holc_gradecat',
          'tree_canopylt25cat',
          'immature_trees_nonecat',
          'roof_flat_dark',
          'roof_flat_n',
          'dark_roof_n',
          'airc_none',
          'Central_Aiyn', 
          'GEOID10',
          'highschool40_ice',
          'medianhomevalue40',
          'ice_1418_blkcat',
          'ICE_blk_inc_1418', 
          'ice1418cat')]

out_start=2
out_end= 8
out_nvar=out_end-out_start+1
out_variable=rep(NA, out_nvar)

out_beta1=rep(NA, out_nvar)
out_se1 = rep(NA, out_nvar)
out_beta2=rep(NA, out_nvar)
out_se2 = rep(NA, out_nvar)
out_beta3=rep(NA, out_nvar)
out_se3 = rep(NA, out_nvar)

rr1 = rep(NA, out_nvar)
ll1 = rep(NA, out_nvar)
ul1 = rep(NA, out_nvar)

rr2 = rep(NA, out_nvar)
ll2 = rep(NA, out_nvar)
ul2 = rep(NA, out_nvar)

rr3 = rep(NA, out_nvar)
ll3 = rep(NA, out_nvar)
ul3 = rep(NA, out_nvar)

number=1
for (i in out_start:out_end){
  
  outcome = colnames(data)[i]
  
  model <- geeglm(get(outcome) ~as.factor(holc_gradecat) + as.factor(ice1418cat), 
                  family= poisson(link = "log"), data=data,
                  id      = GEOID10,
                  corstr  = "exchangeable")
  
  out_beta1[number] = summary(model)$coefficients[2,1]
  out_se1[number]  = summary(model)$coefficients[2,2]
  rr1[number] = exp(summary(model)$coefficients[2,1])
  ll1[number] = exp(summary(model)$coefficients[2,1] - (1.96*summary(model)$coefficients[2,2]))
  ul1[number] = exp(summary(model)$coefficients[2,1] + (1.96*summary(model)$coefficients[2,2]))
  
  
  out_beta2[number]  = summary(model)$coefficients[3,1]
  out_se2[number]  = summary(model)$coefficients[3,2]
  rr2[number] = exp(summary(model)$coefficients[3,1])
  ll2[number] = exp(summary(model)$coefficients[3,1] - (1.96*summary(model)$coefficients[3,2]))
  ul2[number] = exp(summary(model)$coefficients[3,1] + (1.96*summary(model)$coefficients[3,2]))
  
  out_beta3[number]  = summary(model)$coefficients[4,1]
  out_se3[number]  = summary(model)$coefficients[4,2]
  rr3[number] = exp(summary(model)$coefficients[4,1])
  ll3[number] = exp(summary(model)$coefficients[4,1] - (1.96*summary(model)$coefficients[4,2]))
  ul3[number] = exp(summary(model)$coefficients[4,1] + (1.96*summary(model)$coefficients[4,2]))
  
  out_variable[number] = outcome
  
  number = number + 1
  
}

#merge together all the results data frames
results<-data.frame(out_variable, out_beta1, out_se1,out_beta2, out_se2,out_beta3, out_se3,
                    rr1, ll1, ul1, rr2, ll2,ul2, rr3, ll3, ul3)


#round results
results2= data.frame(out_variable, round(results[2:16], 3))

results3<-results2[c(1, 8:16)]


#rename column names
colnames(results3)<-c("Outcome", "Grade B RR ", "Grade B  LL", "Grade B  UL",
                      "Grade C RR", "Grade C  LL", "Grade C  UL",
                      "Grade D RR ", "Grade D LL", "Grade D UL")

results4<-rapply(object = results3, f = round, classes = "numeric",
                 how = "replace", digits = 2) 


write.csv(results4, "C:/Users/lhs36/OneDrive - Drexel University/Redlining/urban_heat_redlining/results/20211115_modelE.HOLC_adjblkice1418cat.csv")

#decide to keep this as a cotinuous term b/c in some prelim analysis I found that
# the AIC was smaller when modeled as a continuous rather than categorical term

############# calculate land area in each HOLC area## T
# This is to determine the amount of properties that were inventoried per km2

#############
crs(x)
newcrs <- CRS("+proj=longlat +datum=WGS84")

xn<-spTransform(x, newcrs)


xn$n.area_sqkm <- area(x) / 1000000

apz<-aggregate(xn$n.area_sqkm, by=list(Category=x$holc_grade), FUN=sum)

total<-sum(xn$n.area_sqkm)